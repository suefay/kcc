package posa

import (
	"crypto/md5"
	"fmt"
	"math/big"
	"reflect"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/state"
)

// each patch is a state mutating function
type patch func(state *state.StateDB)

// Ishikari patch001: fix minor issues found on testnet
func getIshikariPatch001() []patch {
	return []patch{
		patch001ValidatorsContract,
		patch001PunishContract,
	}
}

// Updated at 2022.Jun.13
// After testing on the testnet,
// We found some minor issues in the Ishikari master contracts.
//
// These minor issues are fixed in the following patches

func patch001ValidatorsContract(state *state.StateDB) {

	// source:
	// checksum:
	// @cary TODO: new validators contract code
	// Minor Bug Fixed:
	//   - Diasbled pools should not share the mining rewards
	//   - The commission rate can be changed by the manager of a validator
	code := common.FromHex("0x6080604052600436106103e85760003560e01c8063967945c711610208578063c457865811610118578063d6c0edad116100ab578063ee16442e1161007a578063ee16442e14610b5e578063f1143a4614610b7e578063f165629614610b9e578063f851a44014610bbe578063fd2d4b6a14610bd357610428565b8063d6c0edad14610b17578063dbff2dfd14610b1f578063e5a99f4f14610b34578063edf4a3c314610b4957610428565b8063c76f8d40116100e7578063c76f8d4014610a97578063ce3d1daf14610ab7578063d084029814610ad7578063d279c19114610af757610428565b8063c457865814610a22578063c46102cc14610a42578063c531869d14610a62578063c6a84c0314610a7757610428565b8063a8bc58f21161019b578063badca8191161016a578063badca81914610980578063bbb9e4d1146109a0578063beb2291a146109b5578063c2657c4d146109e2578063c3d117bf14610a0257610428565b8063a8bc58f214610916578063afeea1151461092b578063b21dfed214610940578063b7c131351461096057610428565b80639e83513d116101d75780639e83513d146108ac578063a0dc2758146108c1578063a2340d37146108d6578063a4bfe259146108f657610428565b8063967945c71461082a5780639ced7e761461084a5780639d771a041461086a5780639de702581461088a57610428565b80635463080f1161030357806361167fe71161029657806379c728501161026557806379c72850146107a25780637c01f053146107b5578063862fab42146107d5578063863a20b7146107f55780638f2839701461080a57610428565b806361167fe71461072d57806369ee53fa1461074d5780636dd7d8ea1461076d578063714897df1461078057610428565b80635b337c2c116102d25780635b337c2c146106c35780635bcee382146106e357806360b1d7281461070357806360c80cbf1461071857610428565b80635463080f1461064357806356713343146106635780635785a619146106835780635b16ebb7146106a357610428565b806333ad1e011161037b57806346f751381161034a57806346f75138146105d9578063496188e2146105ee5780634a9b826a1461060357806351cff8d91461062357610428565b806333ad1e01146105575780633619e9c3146105775780633c3000ba1461059757806340550a1c146105ac57610428565b8063205f5180116103b7578063205f5180146104d357806323382609146104e85780632687e03a146105085780632e011c1e1461052857610428565b80630c65f52c1461042d5780630f208beb1461044257806314f64c781461047957806318e018dc146104a657610428565b36610428577f23d6854f607f94ebfa6016da2a230f6517948e27c51aa087451196d47ddf6928333460405161041e929190615646565b60405180910390a1005b600080fd5b61044061043b36600461518e565b610bf3565b005b34801561044e57600080fd5b5061046261045d3660046151a9565b610dd7565b6040516104709291906163cf565b60405180910390f35b34801561048557600080fd5b506104996104943660046154fd565b610dfb565b6040516104709190615632565b3480156104b257600080fd5b506104c66104c136600461518e565b610e22565b60405161047091906163b6565b3480156104df57600080fd5b506104c6610e44565b3480156104f457600080fd5b5061049961050336600461518e565b610e4a565b34801561051457600080fd5b506104c661052336600461518e565b610e6b565b34801561053457600080fd5b5061054861054336600461518e565b610e89565b60405161047093929190615755565b34801561056357600080fd5b506104406105723660046152a4565b61105a565b34801561058357600080fd5b506104c661059236600461518e565b611092565b3480156105a357600080fd5b506104c66110b0565b3480156105b857600080fd5b506105cc6105c736600461518e565b6110b6565b6040516104709190615737565b3480156105e557600080fd5b50610499611111565b3480156105fa57600080fd5b506104c6611120565b34801561060f57600080fd5b506105cc61061e366004615550565b611126565b34801561062f57600080fd5b5061044061063e36600461518e565b611146565b34801561064f57600080fd5b5061044061065e3660046154fd565b6111eb565b34801561066f57600080fd5b506105cc61067e36600461518e565b611277565b34801561068f57600080fd5b506105cc61069e3660046154fd565b611298565b3480156106af57600080fd5b506105cc6106be36600461518e565b6112ad565b3480156106cf57600080fd5b506104406106de3660046154fd565b6112cd565b3480156106ef57600080fd5b506104406106fe36600461539b565b61134e565b34801561070f57600080fd5b506104c66113fa565b34801561072457600080fd5b50610499611400565b34801561073957600080fd5b506104c661074836600461518e565b61140f565b34801561075957600080fd5b506104c661076836600461518e565b61142d565b61044061077b36600461518e565b61144b565b34801561078c57600080fd5b50610795611584565b60405161047091906163a7565b6104406107b03660046151dd565b611589565b3480156107c157600080fd5b506104406107d03660046152a4565b611c56565b3480156107e157600080fd5b506104406107f03660046152db565b611e26565b34801561080157600080fd5b50610499611f88565b34801561081657600080fd5b5061044061082536600461518e565b611f97565b34801561083657600080fd5b506104c661084536600461518e565b611fe3565b34801561085657600080fd5b506104c66108653660046151a9565b612001565b34801561087657600080fd5b5061044061088536600461518e565b612016565b34801561089657600080fd5b5061089f6120d3565b604051610470919061565f565b3480156108b857600080fd5b506104c6612136565b3480156108cd57600080fd5b506104c661213c565b3480156108e257600080fd5b506104c66108f136600461518e565b612142565b34801561090257600080fd5b5061044061091136600461552d565b612160565b34801561092257600080fd5b506104c66122b6565b34801561093757600080fd5b5061089f6122bc565b34801561094c57600080fd5b5061089f61095b36600461518e565b6123cd565b34801561096c57600080fd5b5061044061097b3660046153db565b612499565b34801561098c57600080fd5b506105cc61099b3660046151a9565b6128e3565b3480156109ac57600080fd5b506104c661294a565b3480156109c157600080fd5b506109d56109d036600461518e565b612950565b60405161047091906156ac565b3480156109ee57600080fd5b506104c66109fd36600461518e565b612bd4565b348015610a0e57600080fd5b50610440610a1d3660046154fd565b612bf2565b348015610a2e57600080fd5b50610440610a3d366004615371565b612c73565b348015610a4e57600080fd5b50610440610a5d36600461518e565b612e54565b348015610a6e57600080fd5b506104c6612f09565b348015610a8357600080fd5b50610440610a9236600461518e565b612f15565b348015610aa357600080fd5b50610462610ab23660046151a9565b61305d565b348015610ac357600080fd5b506104c6610ad236600461518e565b613081565b348015610ae357600080fd5b506104c6610af236600461518e565b61309f565b348015610b0357600080fd5b50610440610b1236600461518e565b6130bd565b6104406130fc565b348015610b2b57600080fd5b506104c66134bc565b348015610b4057600080fd5b506104996134c2565b348015610b5557600080fd5b506104c66134d1565b348015610b6a57600080fd5b50610440610b79366004615371565b6134d7565b348015610b8a57600080fd5b50610440610b993660046154fd565b613541565b348015610baa57600080fd5b506104c6610bb936600461518e565b6135c2565b348015610bca57600080fd5b506104996135e0565b348015610bdf57600080fd5b50610440610bee3660046154fd565b6135ef565b603854600160a01b900460ff16610c255760405162461bcd60e51b8152600401610c1c906161e3565b60405180910390fd5b6038805460ff60a01b191690553415801590610c505750610c4e34670de0b6b3a7640000613670565b155b610c6c5760405162461bcd60e51b8152600401610c1c906159cc565b6000610c8034670de0b6b3a76400006136b2565b6001600160a01b03838116600090815260776020526040902060010154919250163314610cbf5760405162461bcd60e51b8152600401610c1c90615c75565b6001600160a01b0382166000908152607760205260409020600281015415610cea57610cea836136f4565b6002810154610cf9908361379b565b60028201819055600a820154610d1f9164e8d4a5100091610d19916137c0565b906136b2565b60038201556009810154610d33908361379b565b6009820155606a54610d45908361379b565b606a55606f54600282015410801590610d625750600d81015460ff165b15610d7457610d7460706077856137fa565b826001600160a01b0316336001600160a01b03167ff297865ac57d5e90b6602e368c1ee6df8104228d78fce8ed8923b48a9694796434604051610db791906163b6565b60405180910390a350506038805460ff60a01b1916600160a01b17905550565b607a6020908152600092835260408084209091529082529020805460019091015482565b607e8181548110610e0857fe5b6000918252602090912001546001600160a01b0316905081565b6001600160a01b0381166000908152607760205260409020600601545b919050565b606b5481565b6001600160a01b039081166000908152607760205260409020600101541690565b6001600160a01b031660009081526077602052604090206005015490565b60786020908152600091825260409182902080548351601f60026000196101006001861615020190931692909204918201849004840281018401909452808452909291839190830182828015610f205780601f10610ef557610100808354040283529160200191610f20565b820191906000526020600020905b815481529060010190602001808311610f0357829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610fbe5780601f10610f9357610100808354040283529160200191610fbe565b820191906000526020600020905b815481529060010190602001808311610fa157829003601f168201915b50505060028085018054604080516020601f60001961010060018716150201909416959095049283018590048502810185019091528181529596959450909250908301828280156110505780601f1061102557610100808354040283529160200191611050565b820191906000526020600020905b81548152906001019060200180831161103357829003601f168201915b5050505050905083565b6038546001600160a01b031633146110845760405162461bcd60e51b8152600401610c1c9061588a565b61108e8282613b60565b5050565b6001600160a01b031660009081526077602052604090206007015490565b606e5481565b6000805b607e5481101561110857826001600160a01b0316607e82815481106110db57fe5b6000918252602090912001546001600160a01b03161415611100576001915050610e3f565b6001016110ba565b50600092915050565b6033546001600160a01b031681565b610bb881565b607660209081526000928352604080842090915290825290205460ff1681565b603854600160a01b900460ff1661116f5760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b19169055336001600160a01b03821614156111a55760405162461bcd60e51b8152600401610c1c906162ec565b6111af33826128e3565b6111cb5760405162461bcd60e51b8152600401610c1c90616349565b6111d53382613bf5565b506038805460ff60a01b1916600160a01b179055565b6038546001600160a01b031633146112155760405162461bcd60e51b8152600401610c1c9061588a565b606e548114156112375760405162461bcd60e51b8152600401610c1c90615fe6565b606e8190556040517fd045295f12ef4f160f8803b90edaa025c769d65531eab370dc395fc297ac5ac79061126c9083906163b6565b60405180910390a150565b6001600160a01b03166000908152607760205260409020600d015460ff1690565b60796020526000908152604090205460ff1681565b6001600160a01b0390811660009081526077602052604090205416151590565b6038546001600160a01b031633146112f75760405162461bcd60e51b8152600401610c1c9061588a565b606b548114156113195760405162461bcd60e51b8152600401610c1c90615fe6565b606b8190556040517fb1af0e731cd364da26a491d6c9e37100decbf030b0f444b8eb3601dfec2ade3a9061126c9083906163b6565b33411461136d5760405162461bcd60e51b8152600401610c1c90615eaf565b603754438161137857fe5b06156113965760405162461bcd60e51b8152600401610c1c9061596b565b43600090815260766020908152604080832060018085529252909120805460ff1916909117905580158015906113cd5750601d8111155b6113e95760405162461bcd60e51b8152600401610c1c90615daa565b6113f5607e8383614ebc565b505050565b606d5481565b6036546001600160a01b031681565b6001600160a01b031660009081526077602052604090206003015490565b6001600160a01b03166000908152607760205260409020600b015490565b603854600160a01b900460ff166114745760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556001600160a01b0381166000908152607760205260409020606f54600282015410156114bf5760405162461bcd60e51b8152600401610c1c90616138565b336001600160a01b03831614156114e85760405162461bcd60e51b8152600401610c1c906162ec565b60006114fc34670de0b6b3a76400006136b2565b905060003411801561150e5750600081115b61152a5760405162461bcd60e51b8152600401610c1c906159cc565b600061153e82670de0b6b3a76400006137c0565b9050600061154c3483613cfb565b905061155a33868587613d3d565b801561156a5761156a8133613ee1565b50506038805460ff60a01b1916600160a01b179055505050565b601d81565b603854600160a01b900460ff166115b25760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556115d134670de0b6b3a7640000613670565b156115ee5760405162461bcd60e51b8152600401610c1c9061601d565b60008581526079602052604090205460ff161561161d5760405162461bcd60e51b8152600401610c1c906161ac565b60008581526079602052604090819020805460ff1916600117905560355490516377f085c560e01b81526001600160a01b03909116906377f085c590611669908a908990600401615646565b60206040518083038186803b15801561168157600080fd5b505afa158015611695573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116b991906154e1565b6116d55760405162461bcd60e51b8152600401610c1c90615de1565b6038546001600160a01b03163314806116f65750336001600160a01b038816145b6117125760405162461bcd60e51b8152600401610c1c906158b1565b6001600160a01b0387166117385760405162461bcd60e51b8152600401610c1c90615faf565b610bb884111561175a5760405162461bcd60e51b8152600401610c1c90615e52565b6001600160a01b0387166000908152607760205260409020600d015460ff16156117965760405162461bcd60e51b8152600401610c1c906162b5565b60006117aa34670de0b6b3a76400006136b2565b6001600160a01b03808a1660008181526077602052604090205492935091161415611971576001600160a01b0388166000908152607760205260409020606f546002820154106117fd576117fd896136f4565b6001600160a01b0388166000908152607d6020526040902061181f908a613f9e565b50600281015461182f908361379b565b60028201819055600a82015461184f9164e8d4a5100091610d19916137c0565b60038201556009810154611863908361379b565b6009820155600d81018054600160ff199091168117909155810180546001600160a01b0319166001600160a01b038a8116919091179091558916600090815260786020908152604090912085516118bc92870190614f1f565b506001600160a01b038916600090815260786020908152604090912084516118ec92600190920191860190614f1f565b506001600160a01b0389166000908152607860209081526040909120865161191c92600290920191880190614f1f565b50876001600160a01b0316896001600160a01b03167f01afec26da4639ca59757acff9f9c2774466c95095a1d87e4aec0379871997eb8860016040516119639291906163bf565b60405180910390a350611bf8565b604051806101c00160405280896001600160a01b03168152602001886001600160a01b031681526020018281526020016000815260200186815260200160008152602001600081526020014381526020016119d7606c544261379b90919063ffffffff16565b815260200182815260200160008152602001600081526020016000815260200160011515815250607760008a6001600160a01b03166001600160a01b0316815260200190815260200160002060008201518160000160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555060208201518160010160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555060408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e082015181600701556101008201518160080155610120820151816009015561014082015181600a015561016082015181600b015561018082015181600c01556101a082015181600d0160006101000a81548160ff021916908315150217905550905050604051806060016040528084815260200183815260200185815250607860008a6001600160a01b03166001600160a01b031681526020019081526020016000206000820151816000019080519060200190611b70929190614f1f565b506020828101518051611b899260018501920190614f1f565b5060408201518051611ba5916002840191602090910190614f1f565b50905050866001600160a01b0316886001600160a01b03167f01afec26da4639ca59757acff9f9c2774466c95095a1d87e4aec0379871997eb876000604051611bef9291906163bf565b60405180910390a35b606f546001600160a01b03891660009081526077602052604090206002015410611c2957611c29607060778a6137fa565b606a54611c36908261379b565b606a5550506038805460ff60a01b1916600160a01b179055505050505050565b6034546001600160a01b03163314611c805760405162461bcd60e51b8152600401610c1c9061610a565b8015611c9157611c91826000613b60565b606e546001600160a01b038316600090815260776020526040812060038101546002820154600a830154929392611cde9291611cd89164e8d4a5100091610d1991906137c0565b90613cfb565b9050600083836005015410611d1c576005830154611cfc9085613cfb565b60058401556006830154611d10908561379b565b60068401555082611dc6565b6000611d35846005015486613cfb90919063ffffffff16565b9050611d4e84600501548361379b90919063ffffffff16565b9150611d6b8460050154856006015461379b90919063ffffffff16565b600685015560006005850155808310611da3576003840154611d8d908261379b565b6003850155611d9c828261379b565b9150611dc4565b6003840154611db2908461379b565b6003850155611dc1828461379b565b91505b505b603654611ddc906001600160a01b031682613fb3565b43866001600160a01b03167f05599b2455d2edd13c543d8ec4cee26e688c66fce9029652baa0abdfcecda43583604051611e1691906163b6565b60405180910390a3505050505050565b6038546001600160a01b03163314611e505760405162461bcd60e51b8152600401610c1c9061588a565b610bb883511115611e735760405162461bcd60e51b8152600401610c1c90615c3e565b606482511115611e955760405162461bcd60e51b8152600401610c1c9061617f565b603281511115611eb75760405162461bcd60e51b8152600401610c1c90615d7f565b6001600160a01b038416600090815260786020526040902080600201604051611ee091906155c2565b6040518091039020848051906020012014611f0c578351611f0a9060028301906020870190614f1f565b505b604051611f1a9082906155c2565b6040518091039020838051906020012014611f43578251611f419082906020860190614f1f565b505b80600101604051611f5491906155c2565b6040518091039020828051906020012014611f80578151611f7e9060018301906020850190614f1f565b505b505b50505050565b6035546001600160a01b031681565b6038546001600160a01b03163314611fc15760405162461bcd60e51b8152600401610c1c9061588a565b603880546001600160a01b0319166001600160a01b0392909216919091179055565b6001600160a01b031660009081526077602052604090206008015490565b600061200d838361404f565b90505b92915050565b603854600160a01b900460ff1661203f5760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556001600160a01b0380821660008181526077602052604090208054909216146120875760405162461bcd60e51b8152600401610c1c90615864565b60018101546001600160a01b031633146120b35760405162461bcd60e51b8152600401610c1c90615f68565b6120bc826136f4565b50506038805460ff60a01b1916600160a01b179055565b6060607e80548060200260200160405190810160405280929190818152602001828054801561212b57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161210d575b505050505090505b90565b606c5481565b60375481565b6001600160a01b031660009081526077602052604090206004015490565b6001600160a01b0381811660009081526077602052604090206001810154909116331461219f5760405162461bcd60e51b8152600401610c1c906160d3565b600d81015460ff166121c35760405162461bcd60e51b8152600401610c1c9061606f565b80546001600160a01b03166121ea5760405162461bcd60e51b8152600401610c1c90615b8d565b610bb883111561220c5760405162461bcd60e51b8152600401610c1c90615e52565b80600801544210156122305760405162461bcd60e51b8152600401610c1c90615cd3565b80600401548314156122545760405162461bcd60e51b8152600401610c1c9061609c565b60048101839055606c5461226990429061379b565b60088201556040516001600160a01b038316907f3b72e0b66d7c778f32dd63a45b08880ca99a150c9d330e5c5a7065ae70030d3e906122a99086906163b6565b60405180910390a2505050565b60755481565b606060006122d4601d61ffff1660706002015461418b565b9050806122f1575050604080516000815260208101909152612133565b60608167ffffffffffffffff8111801561230a57600080fd5b50604051908082528060200260200182016040528015612334578160200160208202803683370190505b5060705481519192506001600160a01b0316908190839060009061235457fe5b6001600160a01b039092166020928302919091019091015260015b838110156123c4576001600160a01b03918216600090815260746020526040902054835192169182908490839081106123a457fe5b6001600160a01b039092166020928302919091019091015260010161236f565b50909250505090565b6001600160a01b0381166000908152607d602052604081206060916123f1826141a1565b905060608167ffffffffffffffff8111801561240c57600080fd5b50604051908082528060200260200182016040528015612436578160200160208202803683370190505b5090506000805b8381101561248e57600061245186836141ac565b90508084848151811061246057fe5b6001600160a01b039092166020928302919091019091015261248383600161379b565b92505060010161243d565b509095945050505050565b600054610100900460ff16806124b257506124b26141b8565b806124c0575060005460ff16155b6124dc5760405162461bcd60e51b8152600401610c1c90615ed3565b600054610100900460ff16158015612507576000805460ff1961ff0019909116610100171660011790555b8b8814801561251557508b8a145b801561252057508b15155b61253c5760405162461bcd60e51b8152600401610c1c90615822565b6203f480606b556213c680606d5562015180606c5568056bc75e2d63100000606e55612710606f81905561258490670de0b6b3a76400009061257e908f6137c0565b906137c0565b4710156125a35760405162461bcd60e51b8152600401610c1c90615a20565b6125ac876141be565b6125b9868686868661425c565b6125c1614332565b60005b8c81101561283e5760008e8e838181106125da57fe5b90506020020160208101906125ef919061518e565b905060008b8b848181106125ff57fe5b6001600160a01b03851660009081526077602090815260409091209102929092013592508f90508e8581811061263157fe5b9050602002016020810190612646919061518e565b6001820180546001600160a01b03199081166001600160a01b0393841617909155825416908416178155606f546002820155600481018290556000600582018190556006820155436007820155606c546126a190429061379b565b6008820155606f5460098201556000600a8201819055600b8201819055600c8201819055600d8201805460ff191660011790556001600160a01b0384168152607860209081526040808320815192830191829052918390529091612709916002840191614f1f565b5060408051602081019182905260009081905261272a916001840191614f1f565b50604080516020810191829052600090819052612748918391614f1f565b5061275660706077866137fa565b607e54601d11156127ad57607e80546001810182556000919091527f0f2ada1f2dbae48ae468fe0cdb7bcda7d0cffee8545442e682273ba01a6203a70180546001600160a01b0319166001600160a01b0386161790555b6009820154606a546127be9161379b565b606a558f8f868181106127cd57fe5b90506020020160208101906127e2919061518e565b6001600160a01b0316846001600160a01b03167f01afec26da4639ca59757acff9f9c2774466c95095a1d87e4aec0379871997eb8560006040516128279291906163bf565b60405180910390a3505050508060010190506125c4565b5060005b8c8110156128c1576128b8607d60008e8e8581811061285d57fe5b9050602002016020810190612872919061518e565b6001600160a01b03166001600160a01b031681526020019081526020016000208f8f8481811061289e57fe5b90506020020160208101906128b3919061518e565b613f9e565b50600101612842565b5080156128d4576000805461ff00191690555b50505050505050505050505050565b60006128ed614f99565b506001600160a01b038084166000908152607b60209081526040808320938616835292815290829020825180840190935280548084526001909101549183019190915215801590612942575080602001514210155b949350505050565b606f5481565b6001600160a01b0381166000908152607c60205260408120606091612974826141a1565b90508067ffffffffffffffff8111801561298d57600080fd5b506040519080825280602002602001820160405280156129c757816020015b6129b4614fb3565b8152602001906001900390816129ac5790505b5092506000805b82811015612bcb5760006129e285836141ac565b90506129ec614ff9565b506001600160a01b0380821660009081526077602090815260409182902082516101c0810184528154851681526001820154909416918401919091526002810154918301919091526003810154606083015260048101546080830152600581015460a0830152600681015460c0830152600781015460e083015260088101546101008301526009810154610120830152600a810154610140830152600b810154610160830152600c810154610180830152600d015460ff1615156101a0820152612ab4614f99565b506001600160a01b038083166000908152607a60209081526040808320938c168352928152908290208251808401909352805483526001015490820152612af9614f99565b506001600160a01b03808a166000908152607b6020908152604080832093871683529281528282208351808501909452805484526001015490830152612b3f858c61404f565b90506040518060e0016040528085600001516001600160a01b03168152602001856101200151815260200185608001518152602001846000015181526020018281526020018360000151815260200183602001518152508a8881518110612ba257fe5b6020908102919091010152612bb887600161379b565b965050600190940193506129ce92505050565b50505050919050565b6001600160a01b031660009081526077602052604090206002015490565b6038546001600160a01b03163314612c1c5760405162461bcd60e51b8152600401610c1c9061588a565b606f54811415612c3e5760405162461bcd60e51b8152600401610c1c90615fe6565b606f8190556040517faa013f7784cb6a7e4b908ae680fb75d44d826bcec005582a91d91cc8eba9c5f89061126c9083906163b6565b603854600160a01b900460ff16612c9c5760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b1916905580612cc65760405162461bcd60e51b8152600401610c1c90616265565b6001600160a01b03828116600090815260776020526040902060010154163314612d025760405162461bcd60e51b8152600401610c1c90615c75565b6001600160a01b03821660009081526077602052604090206002810154821115612d3e5760405162461bcd60e51b8152600401610c1c90615a64565b612d47836136f4565b612d5183846128e3565b15612d5f57612d5f336143bd565b6009810154612d6e8184613cfb565b6009830155606a54612d809084613cfb565b606a556002820154612d929084613cfb565b60028301819055600a830154612db29164e8d4a5100091610d19916137c0565b6003830155606f5460028301541015612dd557612dd06070856143f8565b612de2565b612de260706077866145cb565b612df0848585606d5461483b565b836001600160a01b0316336001600160a01b03167f25f15cdd571a1fdd95de770368cf68023dc79c8d2d4a0f35208a3b0b07bf23bc85604051612e3391906163b6565b60405180910390a350506038805460ff60a01b1916600160a01b1790555050565b603854600160a01b900460ff16612e7d5760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556001600160a01b038082166000818152607760205260409020805490921614612ec55760405162461bcd60e51b8152600401610c1c90615864565b60018101546001600160a01b03163314612ef15760405162461bcd60e51b8152600401610c1c90615a9b565b612efb82836128e3565b156120bc576120bc826143bd565b670de0b6b3a764000081565b603854600160a01b900460ff16612f3e5760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556001600160a01b038082166000818152607760205260409020805490921614612f865760405162461bcd60e51b8152600401610c1c90615864565b60018101546001600160a01b03163314612fb25760405162461bcd60e51b8152600401610c1c9061590e565b6000816005015411612fd65760405162461bcd60e51b8152600401610c1c9061621a565b60058101805460009091556006820154612ff0908261379b565b6006830155612fff8133613ee1565b81546040516001600160a01b03909116907fa847ccfc1c24e1b6493e19c018745f8e9f60288140e209713efc58517bfc0ce39061303d9084906163b6565b60405180910390a250506038805460ff60a01b1916600160a01b17905550565b607b6020908152600092835260408084209091529082529020805460019091015482565b6001600160a01b03166000908152607760205260409020600a015490565b6001600160a01b031660009081526077602052604090206009015490565b603854600160a01b900460ff166130e65760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b191690556111d5816148c0565b33411461311b5760405162461bcd60e51b8152600401610c1c90615eaf565b603854600160a01b900460ff166131445760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b1916905543600090815260766020908152604080832083805290915290205460ff161561318c5760405162461bcd60e51b8152600401610c1c90615b3c565b4360009081526076602090815260408083208380528252808320805460ff19166001179055603654815163cf813c1d60e01b815291516001600160a01b039091169263cf813c1d926004808201939182900301818787803b1580156131f057600080fd5b505af1158015613204573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906132289190615515565b90508061323557506134a7565b60008061324d8360755461379b90919063ffffffff16565b607e5490915060009015613475576000805b607e5460ff8216101561331a57600060776000607e8460ff168154811061328257fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020606f546002820154919250118015906132c35750600d81015460ff165b156133115761330e60776000607e8560ff16815481106132df57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902060090154849061379b565b92505b5060010161325f565b50801561347357600061332d84836136b2565b905060005b607e5460ff8216101561347057600060776000607e8460ff168154811061335557fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020606f54600282015491925011806133955750600d81015460ff16155b156133a05750613468565b60006133b98260090154856137c090919063ffffffff16565b905060006133da612710610d198560040154856137c090919063ffffffff16565b60058401549091506133ec908261379b565b600584015560006133fd8383613cfb565b905061342d6134228560090154610d1964e8d4a51000856137c090919063ffffffff16565b600a8601549061379b565b600a85015561343c888461379b565b436007860155600c85015490985061345590600161379b565b600c909401939093555050600190960195505b600101613332565b50505b505b808210156134955760405162461bcd60e51b8152600401610c1c90615d22565b61349f8282613cfb565b607555505050505b6038805460ff60a01b1916600160a01b179055565b61271081565b6034546001600160a01b031681565b606a5481565b603854600160a01b900460ff166135005760405162461bcd60e51b8152600401610c1c906161e3565b6038805460ff60a01b19169055336001600160a01b03831614156135365760405162461bcd60e51b8152600401610c1c906162ec565b6120bc338383614996565b6038546001600160a01b0316331461356b5760405162461bcd60e51b8152600401610c1c9061588a565b606d5481141561358d5760405162461bcd60e51b8152600401610c1c90615fe6565b606d8190556040517f6fff7f86bcaae80aa63d8c5380045b255699fbf83b399caec3278c8cccb822639061126c9083906163b6565b6001600160a01b03166000908152607760205260409020600c015490565b6038546001600160a01b031681565b6038546001600160a01b031633146136195760405162461bcd60e51b8152600401610c1c9061588a565b606c5481141561363b5760405162461bcd60e51b8152600401610c1c90615fe6565b606c8190556040517f836d4870c480e504f7e59c68ff0ab6582d14af4475c2a66c16a8f2a0b6c3fd9b9061126c9083906163b6565b600061200d83836040518060400160405280601881526020017f536166654d6174683a206d6f64756c6f206279207a65726f0000000000000000815250614b19565b600061200d83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250614b4d565b6001600160a01b03811660009081526077602052604081209061371683614b84565b905080156137375760018201546137379082906001600160a01b0316613ee1565b61375b64e8d4a51000610d1984600a015485600201546137c090919063ffffffff16565b60038301556040516001600160a01b038416907fef89e1a1006e92f5c35aeca19e2099abded5e99c36b1f1dcdd7131398794c325906122a99084906163b6565b60008282018381101561200d5760405162461bcd60e51b8152600401610c1c90615995565b6000826137cf57506000612010565b828202828482816137dc57fe5b041461200d5760405162461bcd60e51b8152600401610c1c90615e11565b600283015461383f5782546001600160a01b0382166001600160a01b0319918216811785556001808601805490931690911790915560028401805490910190556113f5565b82546001600160a01b0382811691161415613859576113f5565b6001600160a01b038082166000908152600385016020526040902054168061392d5760028401805460019081019091558401546001600160a01b039081166000908152602085905260408082206009908101549386168352912001541161391957506001830180546001600160a01b038381166000818152600388016020908152604080832080549686166001600160a01b03199788161790558654909416825260048901905291909120805483168217905582549091161790556113f5565b5060018301546001600160a01b0316613a12565b6001600160a01b038082166000908152602085905260408082206009908101549386168352912001541161396157506113f5565b6001600160a01b038083166000818152600487016020526040808220548585168352912080546001600160a01b031916918416919091179055600186015490911614156139ca576001840180546001600160a01b0319166001600160a01b038316179055613a12565b6001600160a01b03808316600090815260038601602081815260408084205460048a01835281852054861685529290915290912080546001600160a01b031916919092161790555b5b6001600160a01b03811615801590613a5157506001600160a01b03808216600090815260208590526040808220600990810154938616835291200154115b15613a78576001600160a01b03908116600090815260038501602052604090205416613a13565b6001600160a01b038116613aec5783546001600160a01b038381166000818152600488016020908152604080832080549686166001600160a01b0319978816179055895490941682526003890190528281208054851683179055818152919091208054831690558554909116178455611f82565b6001600160a01b0390811660008181526004860160209081526040808320805496861680855282852080549888166001600160a01b0319998a161790558154909616845260039098019091528082208054861685179055865485168417909655918252939020805490911690921790915550565b6001600160a01b0382166000908152607760205260409020600d81015460ff16151582151514613bbc57600d8101805460ff191683151517905581613baf57613baa6070846143f8565b613bbc565b613bbc60706077856137fa565b826001600160a01b03167f2f62a1a1d6859de456dd8107c09e738da088ceb9f87d90c2e31f91fb3e89b727836040516122a99190615737565b6001600160a01b038083166000908152607b60209081526040808320938516835292905220613c22614f99565b506001600160a01b038083166000908152607a60209081526040808320938716835292815282822083518085019094528054845260010154908301528254908355613c7e613c7882670de0b6b3a76400006137c0565b33613ee1565b8151613ca9576001600160a01b0385166000908152607c60205260409020613ca68186614c75565b50505b836001600160a01b0316856001600160a01b03167f9b1bfa7fa9ee420a16e124f794c35ac9f90472acc99140eb2f6447c714cad8eb83604051613cec91906163b6565b60405180910390a35050505050565b600061200d83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250614c8a565b6001600160a01b038084166000908152607a60209081526040808320938816835292905220805415613dd9576000613d75858761404f565b90508015613dd357613d878133613ee1565b846001600160a01b0316866001600160a01b03167f7e77f685b38c861064cb08f2776eb5dfd3c82f652ed9f21221b8c53b75628e5183604051613dca91906163b6565b60405180910390a35b50613e13565b600b820154613de990600161379b565b600b8301556001600160a01b0385166000908152607c60205260409020613e108186613f9e565b50505b8054613e1f908461379b565b808255600a830154613e3c9164e8d4a5100091610d1991906137c0565b60018201556009820154613e50908461379b565b6009830155606a54613e62908461379b565b606a55606f54600283015410801590613e7f5750600d82015460ff165b15613e9e578154613e9e906070906077906001600160a01b03166137fa565b836001600160a01b0316856001600160a01b03167f66a9138482c99e9baf08860110ef332cc0c23b4a199a53593d8db0fc8f96fbfc85604051613cec91906163b6565b4780831115613f4457613ef48282613fb3565b816001600160a01b0316306001600160a01b03167fa282a314ffba449688a7c5eb4426bd8e1781944ce824ce34dfaea4691d08f14683604051613f3791906163b6565b60405180910390a36113f5565b613f4e8284613fb3565b816001600160a01b0316306001600160a01b03167fa282a314ffba449688a7c5eb4426bd8e1781944ce824ce34dfaea4691d08f14685604051613f9191906163b6565b60405180910390a3505050565b600061200d836001600160a01b038416614cb6565b80471015613fd35760405162461bcd60e51b8152600401610c1c90615bba565b6000826001600160a01b031682604051613fec90612133565b60006040518083038185875af1925050503d8060008114614029576040519150601f19603f3d011682016040523d82523d6000602084013e61402e565b606091505b50509050806113f55760405162461bcd60e51b8152600401610c1c90615adf565b6000614059614ff9565b506001600160a01b0380841660009081526077602090815260409182902082516101c0810184528154851681526001820154909416918401919091526002810154918301919091526003810154606083015260048101546080830152600581015460a0830152600681015460c0830152600781015460e083015260088101546101008301526009810154610120830152600a810154610140830152600b810154610160830152600c810154610180830152600d015460ff1615156101a0820152614121614f99565b506001600160a01b038085166000908152607a60209081526040808320938716835292815290829020825180840190935280548084526001909101549183018290526101408401516141829291611cd89164e8d4a5100091610d19916137c0565b95945050505050565b600081831061419a578161200d565b5090919050565b600061201082614d00565b600061200d8383614d04565b303b1590565b600054610100900460ff16806141d757506141d76141b8565b806141e5575060005460ff16155b6142015760405162461bcd60e51b8152600401610c1c90615ed3565b600054610100900460ff1615801561422c576000805460ff1961ff0019909116610100171660011790555b603880546001600160a01b0319166001600160a01b038416179055801561108e576000805461ff00191690555050565b600054610100900460ff168061427557506142756141b8565b80614283575060005460ff16155b61429f5760405162461bcd60e51b8152600401610c1c90615ed3565b600054610100900460ff161580156142ca576000805460ff1961ff0019909116610100171660011790555b603380546001600160a01b038089166001600160a01b0319928316179092556034805488841690831617905560358054878416908316179055603680549286169290911691909117905560378290558015611f7e576000805461ff0019169055505050505050565b600054610100900460ff168061434b575061434b6141b8565b80614359575060005460ff16155b6143755760405162461bcd60e51b8152600401610c1c90615ed3565b600054610100900460ff161580156143a0576000805460ff1961ff0019909116610100171660011790555b6143a8614d49565b80156143ba576000805461ff00191690555b50565b6001600160a01b0381166000908152607b6020908152604080832090915281208054918155906113f5613c7882670de0b6b3a76400006137c0565b81546001600160a01b0382811691161480159061442f57506001600160a01b03818116600090815260038401602052604090205416155b156144395761108e565b60018201546001600160a01b0382811691161415614485576001600160a01b0380821660009081526003840160205260409020546001840180546001600160a01b031916919092161790555b81546001600160a01b03828116911614156144c8576001600160a01b03808216600090815260048401602052604090205483546001600160a01b03191691161782555b6001600160a01b038082166000908152600484016020526040902054168015614523576001600160a01b038083166000908152600385016020526040808220548484168352912080546001600160a01b031916919092161790555b6001600160a01b03808316600090815260038501602052604090205416801561457e576001600160a01b038084166000908152600486016020526040808220548484168352912080546001600160a01b031916919092161790555b50506001600160a01b03166000908152600382016020908152604080832080546001600160a01b031990811690915560048501909252909120805490911690556002018054600019019055565b6001600160a01b03808216600081815260048601602052604090205460018601549083169216148061460457506001600160a01b038116155b8061463657506001600160a01b0380831660009081526020859052604080822060099081015493851683529120015411155b1561464157506113f5565b6001600160a01b038083166000818152600387016020526040808220548585168352912080546001600160a01b031916918416919091179055855490911614156146a35783546001600160a01b0319166001600160a01b0382161784556146e5565b6001600160a01b0382811660009081526003860160209081526040808320548416835260048801909152902080546001600160a01b0319169183169190911790555b5b6001600160a01b0381161580159061472457506001600160a01b03808316600090815260208590526040808220600990810154938516835291200154115b1561474b576001600160a01b039081166000908152600485016020526040902054166146e6565b6001600160a01b0381166147c1576001840180546001600160a01b038481166000818152600389016020908152604080832080549686166001600160a01b031997881617905560048b01909152808220805486169055855490931681529190912080548316821790558254909116179055611f82565b6001600160a01b0390811660008181526003860160208181526040808420805487168552600490990180835281852080546001600160a01b0319908116998916998a179091558484528a54898752838720805491909916908216179097558252832080548616851790559290915290528354161790915550565b6001600160a01b038085166000908152607b60209081526040808320938716835292905220805461486c908461379b565b8155614878428361379b565b6001820181905581546040516001600160a01b0380881693908916927fd6f80c7d68e3e62bd7a51c3d37e575c1cfbc311c07487b69ef4eb570bc21cb6892613cec92906163cf565b6001600160a01b0381166000908152607a60209081526040808320338085529252822091906148f090849061404f565b9050600081116149125760405162461bcd60e51b8152600401610c1c90615f21565b6001600160a01b0383166000908152607760205260409020600a015482546149449164e8d4a5100091610d19916137c0565b60018301556149538133613ee1565b826001600160a01b0316336001600160a01b03167f7e77f685b38c861064cb08f2776eb5dfd3c82f652ed9f21221b8c53b75628e5183604051613f9191906163b6565b600081116149b65760405162461bcd60e51b8152600401610c1c90615bf1565b6001600160a01b038083166000908152607760209081526040808320607a83528184209488168452939091529020805483811015614a065760405162461bcd60e51b8152600401610c1c90615798565b6000614a12868861404f565b90508015614a7057614a248133613ee1565b856001600160a01b0316876001600160a01b03167f7e77f685b38c861064cb08f2776eb5dfd3c82f652ed9f21221b8c53b75628e5183604051614a6791906163b6565b60405180910390a35b614a7a87876128e3565b15614a8957614a898787613bf5565b6009840154614a989086613cfb565b6009850155614aa78286613cfb565b808455600a850154614ac49164e8d4a5100091610d1991906137c0565b6001840155606a54614ad69086613cfb565b606a558254614af557600b840154614aef906001613cfb565b600b8501555b614b03878787606b5461483b565b614b1060706077886145cb565b50505050505050565b60008183614b3a5760405162461bcd60e51b8152600401610c1c9190615742565b50828481614b4457fe5b06949350505050565b60008183614b6e5760405162461bcd60e51b8152600401610c1c9190615742565b506000838581614b7a57fe5b0495945050505050565b6000614b8e614ff9565b506001600160a01b0380831660009081526077602090815260409182902082516101c081018452815485168152600182015490941691840191909152600281015491830182905260038101546060840181905260048201546080850152600582015460a0850152600682015460c0850152600782015460e085015260088201546101008501526009820154610120850152600a8201546101408501819052600b830154610160860152600c830154610180860152600d9092015460ff1615156101a0850152614c6e929091611cd89164e8d4a5100091610d1991906137c0565b9392505050565b600061200d836001600160a01b038416614dde565b60008184841115614cae5760405162461bcd60e51b8152600401610c1c9190615742565b505050900390565b6000614cc28383614ea4565b614cf857508154600181810184556000848152602080822090930184905584548482528286019093526040902091909155612010565b506000612010565b5490565b81546000908210614d275760405162461bcd60e51b8152600401610c1c906157e0565b826000018281548110614d3657fe5b9060005260206000200154905092915050565b600054610100900460ff1680614d625750614d626141b8565b80614d70575060005460ff16155b614d8c5760405162461bcd60e51b8152600401610c1c90615ed3565b600054610100900460ff16158015614db7576000805460ff1961ff0019909116610100171660011790555b6038805460ff60a01b1916600160a01b17905580156143ba576000805461ff001916905550565b60008181526001830160205260408120548015614e9a5783546000198083019190810190600090879083908110614e1157fe5b9060005260206000200154905080876000018481548110614e2e57fe5b600091825260208083209091019290925582815260018981019092526040902090840190558654879080614e5e57fe5b60019003818190600052602060002001600090559055866001016000878152602001908152602001600020600090556001945050505050612010565b6000915050612010565b60009081526001919091016020526040902054151590565b828054828255906000526020600020908101928215614f0f579160200282015b82811115614f0f5781546001600160a01b0319166001600160a01b03843516178255602090920191600190910190614edc565b50614f1b92915061507c565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10614f6057805160ff1916838001178555614f8d565b82800160010185558215614f8d579182015b82811115614f8d578251825591602001919060010190614f72565b50614f1b92915061509b565b604051806040016040528060008152602001600081525090565b6040518060e0016040528060006001600160a01b031681526020016000815260200160008152602001600081526020016000815260200160008152602001600081525090565b604051806101c0016040528060006001600160a01b0316815260200160006001600160a01b0316815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000151581525090565b5b80821115614f1b5780546001600160a01b031916815560010161507d565b5b80821115614f1b576000815560010161509c565b80356001600160a01b038116811461201057600080fd5b60008083601f8401126150d8578182fd5b50813567ffffffffffffffff8111156150ef578182fd5b602083019150836020808302850101111561510957600080fd5b9250929050565b600082601f830112615120578081fd5b813567ffffffffffffffff80821115615137578283fd5b604051601f8301601f191681016020018281118282101715615157578485fd5b60405282815292508284830160200186101561517257600080fd5b8260208601602083013760006020848301015250505092915050565b60006020828403121561519f578081fd5b61200d83836150b0565b600080604083850312156151bb578081fd5b6151c584846150b0565b91506151d484602085016150b0565b90509250929050565b600080600080600080600060e0888a0312156151f7578283fd5b87356001600160a01b038116811461520d578384fd5b965061521c8960208a016150b0565b95506040880135945060608801359350608088013567ffffffffffffffff80821115615246578485fd5b6152528b838c01615110565b945060a08a0135915080821115615267578384fd5b6152738b838c01615110565b935060c08a0135915080821115615288578283fd5b506152958a828b01615110565b91505092959891949750929550565b600080604083850312156152b6578182fd5b6152c084846150b0565b915060208301356152d0816163dd565b809150509250929050565b600080600080608085870312156152f0578384fd5b6152fa86866150b0565b9350602085013567ffffffffffffffff80821115615316578485fd5b61532288838901615110565b94506040870135915080821115615337578384fd5b61534388838901615110565b93506060870135915080821115615358578283fd5b5061536587828801615110565b91505092959194509250565b60008060408385031215615383578182fd5b61538d84846150b0565b946020939093013593505050565b600080602083850312156153ad578182fd5b823567ffffffffffffffff8111156153c3578283fd5b6153cf858286016150c7565b90969095509350505050565b6000806000806000806000806000806000806101208d8f0312156153fd578485fd5b67ffffffffffffffff8d351115615412578485fd5b61541f8e8e358f016150c7565b909c509a5067ffffffffffffffff60208e0135111561543c578485fd5b61544c8e60208f01358f016150c7565b909a50985067ffffffffffffffff60408e01351115615469578485fd5b6154798e60408f01358f016150c7565b909850965061548b8e60608f016150b0565b955061549a8e60808f016150b0565b94506154a98e60a08f016150b0565b93506154b88e60c08f016150b0565b92506154c78e60e08f016150b0565b91506101008d013590509295989b509295989b509295989b565b6000602082840312156154f2578081fd5b815161200d816163dd565b60006020828403121561550e578081fd5b5035919050565b600060208284031215615526578081fd5b5051919050565b6000806040838503121561553f578182fd5b823591506151d484602085016150b0565b60008060408385031215615562578182fd5b823591506020830135600281106152d0578182fd5b60008151808452815b8181101561559c57602081850181015186830182015201615580565b818111156155ad5782602083870101525b50601f01601f19169290920160200192915050565b60008083546001808216600081146155e157600181146155f857615627565b60ff198316865260028304607f1686019350615627565b600283048786526020808720875b8381101561561f5781548a820152908501908201615606565b505050860193505b509195945050505050565b6001600160a01b0391909116815260200190565b6001600160a01b03929092168252602082015260400190565b6020808252825182820181905260009190848201906040850190845b818110156156a05783516001600160a01b03168352928401929184019160010161567b565b50909695505050505050565b602080825282518282018190526000919060409081850190868401855b8281101561572a57815180516001600160a01b0316855286810151878601528581015186860152606080820151908601526080808201519086015260a0808201519086015260c0908101519085015260e090930192908501906001016156c9565b5091979650505050505050565b901515815260200190565b60006020825261200d6020830184615577565b6000606082526157686060830186615577565b828103602084015261577a8186615577565b9050828103604084015261578e8185615577565b9695505050505050565b60208082526028908201527f56616c696461746f72733a206e6f20656e6f7567682062616c6c6f747320746f604082015267103932bb37b5b29760c11b606082015260800190565b60208082526022908201527f456e756d657261626c655365743a20696e646578206f7574206f6620626f756e604082015261647360f01b606082015260800190565b60208082526022908201527f696e76616c69642076616c696461746f7220616e642069742773206d616e616760408201526132b960f11b606082015260800190565b6020808252600c908201526b1b9bc81cdd58da081c1bdbdb60a21b604082015260600190565b6020808252600d908201526c36bab9ba1031329030b236b4b760991b604082015260600190565b6020808252603d908201527f6f6e6c792076616c696461746f7220696e207468652070726f706f73616c206f60408201527f722061646d696e2063616e2063616c6c2061646456616c696461746f72000000606082015260800190565b6020808252603a908201527f56616c696461746f72733a206f6e6c79206d616e61676572206f66207468652060408201527f706f6f6c2063616e20636c61696d206665652072657761726473000000000000606082015260800190565b60208082526010908201526f426c6f636b2065706f6368206f6e6c7960801b604082015260600190565b6020808252601b908201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604082015260600190565b60208082526034908201527f56616c696461746f72733a20766f746573206d75737420626520696e74656765604082015273391036bab63a34b836329037b310189025a1a99760611b606082015260800190565b60208082526024908201527f6e6f20656e6f756768206b637320696e2076616c696461746f727320636f6e746040820152631c9858dd60e21b606082015260800190565b6020808252601b908201527f56616c696461746f72733a20696e76616c696420616d6f756e742e0000000000604082015260600190565b60208082526024908201527f6f7065726174696f6e206973206f6e6c7920616c6c6f776564206279206d616e60408201526330b3b2b960e11b606082015260800190565b6020808252603a908201527f416464726573733a20756e61626c6520746f2073656e642076616c75652c207260408201527f6563697069656e74206d61792068617665207265766572746564000000000000606082015260800190565b60208082526031908201527f63616e6e6f742062652063616c6c6564206d6f7265207468616e206f6e636520604082015270696e20612073696e676c6520626c6f636b60781b606082015260800190565b602080825260139082015272141bdbdb08191bd95cc81b9bdd08195e1a5cdd606a1b604082015260600190565b6020808252601d908201527f416464726573733a20696e73756666696369656e742062616c616e6365000000604082015260600190565b6020808252602d908201527f746865207265766f6b696e6720616d6f756e74206d757374206265206772656160408201526c746572207468616e207a65726f60981b606082015260800190565b60208082526017908201527f6465736372697074696f6e20697320746f6f206c6f6e67000000000000000000604082015260600190565b602080825260409082018190527f706f6f6c20646f6573206e6f74206578697374206f72206d73672e73656e6465908201527f72206973206e6f7420746865206d616e61676572206f662074686520706f6f6c606082015260800190565b6020808252602f908201527f56616c696461746f72733a206f6e652074696d65206f66206368616e6765207760408201526e34ba3434b710191a103437bab9399760891b606082015260800190565b60208082526038908201527f56616c696461746f72733a20746f74616c417661696c61626c65206973206c6560408201527f7373207468616e20746f74616c44697374726962757465640000000000000000606082015260800190565b602080825260119082015270656d61696c20697320746f6f206c6f6e6760781b604082015260600190565b6020808252601e908201527f696e76616c6964206c656e677468206f66206e65775365742061727261790000604082015260600190565b6020808252601690820152751c1c9bdc1bdcd85b081a5cc81b9bdd081c185cdcd95960521b604082015260600190565b60208082526021908201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6040820152607760f81b606082015260800190565b6020808252603b908201527f56616c696461746f72733a2074686520666565207368617265732073686f756c60408201527f6420626520696e207468652072616e676528302e2e33303030292e0000000000606082015260800190565b6020808252600a90820152694d696e6572206f6e6c7960b01b604082015260600190565b6020808252602e908201527f436f6e747261637420696e7374616e63652068617320616c726561647920626560408201526d195b881a5b9a5d1a585b1a5e995960921b606082015260800190565b60208082526027908201527f56616c696461746f72733a206e6f2070656e64696e672072657761726420746f6040820152661031b630b4b69760c91b606082015260800190565b60208082526027908201527f6f6e6c792074686520706f6f6c206d616e616765722063616e20636c61696d206040820152667265776172647360c81b606082015260800190565b60208082526019908201527f56616c696461746f72733a205a45524f5f414444524553532e00000000000000604082015260600190565b6020808252601f908201527f56616c696461746f72733a204e6f206368616e67652064657465637465642e00604082015260600190565b60208082526032908201527f6d73672e76616c7565206d75737420626520616e20696e7465676572206d756c6040820152713a34b836329037b31030b71032ba3432b91760711b606082015260800190565b6020808252601390820152721c1bdbdb081a5cc81b9bdd08195b98589b1959606a1b604082015260600190565b6020808252601f908201527f56616c696461746f72733a206e6f206368616e67652064657465637465642e00604082015260600190565b6020808252601a908201527f6f6e6c79206d616e616765722063616e206368616e6765206974000000000000604082015260600190565b60208082526014908201527350756e69736820636f6e7472616374206f6e6c7960601b604082015260600190565b60208082526027908201527f56616c696461746f72733a206d7573742072657175697265206d696e53656c6660408201526642616c6c6f747360c81b606082015260800190565b6020808252601390820152727765627369746520697320746f6f206c6f6e6760681b604082015260600190565b60208082526019908201527f70726f706f73616c2063616e6e6f742062652072657573656400000000000000604082015260600190565b6020808252601f908201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604082015260600190565b6020808252602b908201527f56616c696461746f72733a206e6f2070656e64696e672066656520726577617260408201526a32103a379031b630b4b69760a91b606082015260800190565b60208082526030908201527f56616c696461746f72733a2072656465656d20616d6f756e74206d757374206260408201526f0652067726561746572207468616e20360841b606082015260800190565b6020808252601c908201527f616c7265616479206861766520616e20656e61626c656420706f6f6c00000000604082015260600190565b60208082526038908201527f76616c696461746f722063616e206f6e6c7920766f746520746f2068696d736560408201527f6c66206279206465706f736974696e67206d617267696e2e0000000000000000606082015260800190565b602080825260409082018190527f56616c696461746f72733a206e6f2062616c6c6f747320746f20776974686472908201527f6177206f722062616c6c6f747320617265207374696c6c206c6f636b696e672e606082015260800190565b61ffff91909116815260200190565b90815260200190565b9182521515602082015260400190565b918252602082015260400190565b80151581146143ba57600080fdfea2646970667358221220302ccc5cbdecaeeb17bc653b4c77d90d8fdfbd8944afbc9a8700b356c59814e564736f6c634300060c0033")

	// verify code
	verifyMd5Sum(code, common.FromHex("0xcf5dec2eee8d6a3b362f97397753f4df"))

	// Upgrade  codes
	state.SetCode(IshikariValidatorsContractAddr, code)

}

func patch001PunishContract(state *state.StateDB) {

	code := common.FromHex("0x608060405234801561001057600080fd5b506004361061010b5760003560e01c80638f283970116100a2578063e0d8ea5311610071578063e0d8ea5314610237578063e5a99f4f1461023f578063ea7221a114610247578063f62af26c1461026d578063f851a4401461028a5761010b565b80638f283970146101b557806395b6ef0c146101db578063a0dc275814610227578063cb1ea7251461022f5761010b565b80635e81f1f8116100de5780635e81f1f81461017c57806360c80cbf14610186578063714897df1461018e578063863a20b7146101ad5761010b565b80632897183d1461011057806332f3c17f1461012a57806344c1aa991461015057806346f7513814610158575b600080fd5b610118610292565b60408051918252519081900360200190f35b6101186004803603602081101561014057600080fd5b50356001600160a01b0316610298565b6101186102b3565b6101606102b9565b604080516001600160a01b039092168252519081900360200190f35b6101846102c8565b005b610160610525565b610196610534565b6040805161ffff9092168252519081900360200190f35b610160610539565b610184600480360360208110156101cb57600080fd5b50356001600160a01b0316610548565b610184600480360360c08110156101f157600080fd5b506001600160a01b0381358116916020810135821691604082013581169160608101358216916080820135169060a001356105b9565b610118610686565b61011861068c565b610118610692565b610160610698565b6101846004803603602081101561025d57600080fd5b50356001600160a01b03166106a7565b6101606004803603602081101561028357600080fd5b5035610a0a565b610160610a31565b603b5481565b6001600160a01b03166000908152603c602052604090205490565b603a5481565b6033546001600160a01b031681565b334114610309576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152603f602052604090205460ff1615610363576040805162461bcd60e51b8152602060048201526012602482015271105b1c9958591e4817d91958dc99585cd95960721b604482015290519081900360640190fd5b603754438161036e57fe5b06156103b4576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b436000908152603f60205260409020805460ff19166001179055603d546103da57610523565b60005b603d548110156104f857603b54603a54816103f457fe5b04603c6000603d848154811061040657fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205411156104b757603b54603a548161043e57fe5b04603c6000603d848154811061045057fe5b60009182526020808320909101546001600160a01b03168352820192909252604001812054603d80549390910392603c9291908590811061048d57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020556104f0565b6000603c6000603d84815481106104ca57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020555b6001016103dd565b506040517f181d51be54e8e8eaca6eae0eab32d4162099236bd519e7238d015d0870db464190600090a15b565b6036546001600160a01b031681565b601d81565b6035546001600160a01b031681565b6038546001600160a01b03163314610597576040805162461bcd60e51b815260206004820152600d60248201526c36bab9ba1031329030b236b4b760991b604482015290519081900360640190fd5b603880546001600160a01b0319166001600160a01b0392909216919091179055565b600054610100900460ff16806105d257506105d2610a40565b806105e0575060005460ff16155b61061b5760405162461bcd60e51b815260040180806020018281038252602e815260200180610d84602e913960400191505060405180910390fd5b600054610100900460ff16158015610646576000805460ff1961ff0019909116610100171660011790555b61064f83610a46565b61065c8787878786610b04565b601860398190556030603a55603b55801561067d576000805461ff00191690555b50505050505050565b60375481565b60395481565b603d5490565b6034546001600160a01b031681565b3341146106e8576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152603e602052604090205460ff1615610741576040805162461bcd60e51b8152602060048201526011602482015270105b1c9958591e4817dc1d5b9a5cda1959607a1b604482015290519081900360640190fd5b436000908152603e6020908152604091829020805460ff191660011790556033548251635671334360e01b81526001600160a01b03858116600483015293519390911692635671334392602480840193919291829003018186803b1580156107a857600080fd5b505afa1580156107bc573d6000803e3d6000fd5b505050506040513d60208110156107d257600080fd5b50516107dd57610a07565b6001600160a01b0381166000908152603c602052604090206002015460ff1661086e57603d80546001600160a01b0383166000818152603c6020526040812060018082018590558085019095557fece66cfdbd22e3f37d348a3d8e19074452862cd65fd4b9a11f0336d1ac6d1dc390930180546001600160a01b0319168317905552600201805460ff191690911790555b6001600160a01b0381166000908152603c60205260409020805460010190819055603a54908161089a57fe5b066109335760335460408051637c01f05360e01b81526001600160a01b0384811660048301526001602483015291519190921691637c01f05391604480830192600092919082900301818387803b1580156108f457600080fd5b505af1158015610908573d6000803e3d6000fd5b5050506001600160a01b0382166000908152603c60205260408120555061092e81610bfa565b6109c7565b6039546001600160a01b0382166000908152603c60205260409020548161095657fe5b066109c75760335460408051637c01f05360e01b81526001600160a01b0384811660048301526000602483018190529251931692637c01f0539260448084019391929182900301818387803b1580156109ae57600080fd5b505af11580156109c2573d6000803e3d6000fd5b505050505b6040805142815290516001600160a01b038316917f770e0cca42c35d00240986ce8d3ed438be04663c91dac6576b79537d7c180f1e919081900360200190a25b50565b603d8181548110610a1757fe5b6000918252602090912001546001600160a01b0316905081565b6038546001600160a01b031681565b303b1590565b600054610100900460ff1680610a5f5750610a5f610a40565b80610a6d575060005460ff16155b610aa85760405162461bcd60e51b815260040180806020018281038252602e815260200180610d84602e913960400191505060405180910390fd5b600054610100900460ff16158015610ad3576000805460ff1961ff0019909116610100171660011790555b603880546001600160a01b0319166001600160a01b0384161790558015610b00576000805461ff00191690555b5050565b600054610100900460ff1680610b1d5750610b1d610a40565b80610b2b575060005460ff16155b610b665760405162461bcd60e51b815260040180806020018281038252602e815260200180610d84602e913960400191505060405180910390fd5b600054610100900460ff16158015610b91576000805460ff1961ff0019909116610100171660011790555b603380546001600160a01b038089166001600160a01b0319928316179092556034805488841690831617905560358054878416908316179055603680549286169290911691909117905560378290558015610bf2576000805461ff00191690555b505050505050565b6001600160a01b0381166000908152603c602052604090205415610c32576001600160a01b0381166000908152603c60205260408120555b6001600160a01b0381166000908152603c602052604090206002015460ff168015610c5e5750603d5415155b15610a0757603d546001600160a01b0382166000908152603c602052604090206001015460001990910114610d2857603d8054600091906000198101908110610ca357fe5b60009182526020808320909101546001600160a01b038581168452603c909252604090922060010154603d80549290931693508392918110610ce157fe5b600091825260208083209190910180546001600160a01b0319166001600160a01b039485161790558483168252603c90526040808220600190810154949093168252902001555b603d805480610d3357fe5b60008281526020808220830160001990810180546001600160a01b03191690559092019092556001600160a01b0383168252603c9052604081206001810191909155600201805460ff191690555056fe436f6e747261637420696e7374616e63652068617320616c7265616479206265656e20696e697469616c697a6564a2646970667358221220d08e97ffea4ab48a59d6a8300e8a6d178aebf94651752cdc426a01943f551f2f64736f6c634300060c0033")

	// verify code
	verifyMd5Sum(code, common.FromHex("0xf6ab56760ef5897c4295e99e240d343b"))

	// Upgrade
	state.SetCode(IshikariPunishContractAddr, code)

	// Change Ishikari Punish Contract state slots
	//
	//   storage variable       slot        offset
	//  punishThreshold         57         0     t_uint256                                                                     
	//  removeThreshold         58         0     t_uint256                                                                     
	//  decreaseRate            59         0     t_uint256
	//

	state.SetState(IshikariPunishContractAddr,
		common.BigToHash(big.NewInt(58)),
		common.BigToHash(big.NewInt(600)))
}

func verifyMd5Sum(data []byte, expectedSum []byte) {

	hasher := md5.New()
	hasher.Write(data)

	sum := hasher.Sum(nil)

	if !reflect.DeepEqual(sum, expectedSum) {
		panic(fmt.Sprintf("mismatched md5sum! expected(%v) != actual(%v)",
			common.Bytes2Hex(sum), common.Bytes2Hex(expectedSum)))
	}
}

// Ishikari Patch002: For each epoch, a validator can miss at most 2 blocks.
func getIshikariPatch002() []patch {
	return []patch{
		patch002PunishContract,
	}
}

func patch002PunishContract(state *state.StateDB) {

	// Change Ishikari Punish Contract state slots
	//
	//   storage variable       slot        offset
	//  punishThreshold         57         0     t_uint256                                                                     
	//  removeThreshold         58         0     t_uint256                                                                     
	//  decreaseRate            59         0     t_uint256
	//

	// For each epoch, a validator can miss at most 2 blocks.
	state.SetState(IshikariPunishContractAddr,
		common.BigToHash(big.NewInt(59)),
		common.BigToHash(big.NewInt(300)))
}
